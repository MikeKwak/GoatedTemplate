version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        - npm run build --workspace=packages/shared
    build:
      commands:
        - npm run build:web
        - |
          # Create deploy-manifest.json in the build output directory for Amplify Hosting
          mkdir -p web/.next
          cat > web/.next/deploy-manifest.json << 'EOF'
          {
            "version": 1,
            "framework": "nextjs",
            "baseDirectory": ".next",
            "routes": [
              {
                "path": "/*",
                "target": {
                  "kind": "rewrite",
                  "source": "/*"
                }
              }
            ]
          }
          EOF
  artifacts:
    baseDirectory: web/.next
    files:
      - '**/*'
  cache:
    paths:
      - web/node_modules/**/*
      - web/.next/cache/**/*
      - node_modules/**/*

