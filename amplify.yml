version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Explicitly use Node 20 (required as Amplify ended support for Node 14/16/18)
        - nvm install 20
        - nvm use 20
        - node -v
        - echo "Node version: $(node --version)"
        - echo "NPM version: $(npm --version)"
        # Install dependencies
        - npm ci
        - npm run build --workspace=packages/shared
    build:
      commands:
        # Build Next.js application
        - npm run build:web
        # Create deploy-manifest.json in the .amplify-hosting directory for Amplify Hosting
        # Next.js standalone output is in .next/standalone
        - |
          mkdir -p web/.next/standalone/.amplify-hosting
          cat > web/.next/standalone/.amplify-hosting/deploy-manifest.json << 'EOF'
          {
            "version": 1,
            "routes": [
              {
                "path": "/_next/image",
                "target": {
                  "kind": "ImageOptimization",
                  "cacheControl": "public, max-age=3600, immutable"
                }
              },
              {
                "path": "/_next/static/*",
                "target": {
                  "cacheControl": "public, max-age=31536000, immutable",
                  "kind": "Static"
                }
              },
              {
                "path": "/*",
                "target": {
                  "kind": "Compute",
                  "src": "default"
                }
              }
            ],
            "computeResources": [
              {
                "name": "default",
                "entrypoint": "server.js",
                "runtime": "nodejs20.x"
              }
            ],
            "framework": {
              "name": "next.js",
              "version": "16.0.7"
            }
          }
          EOF
  artifacts:
    baseDirectory: web/.next/standalone
    files:
      - '**/*'
  cache:
    paths:
      - web/node_modules/**/*
      - web/.next/cache/**/*
      - node_modules/**/*
      - packages/shared/node_modules/**/*
  settings:
    nodeVersion: "20"

